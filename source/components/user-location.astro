---
import type { HTMLAttributes } from "astro/types";
import CircleHelp from "~icons/lucide/circle-help";

type Props = HTMLAttributes<"span">;
// TODO: Serverless function to synchronize last info on each visit.
---

<script>
  import tippy from "tippy.js";

  const response = await fetch("https://geolocation.microlink.io");
  const { country, city } = await response.json();

  const placeholder = document.querySelector("span#location-placeholder")!;
  placeholder.textContent = `Last visit from ${city.name}, ${country.name} ${country.flag}`;

  // Sets the tooltip for the privacy notice.
  const template = document.getElementById("privacy-notice");
  tippy("#location-privacy-tooltip", {
    content: template?.innerHTML,
    theme: "location",
    offset: [0, 16],

    arrow: false,
    allowHTML: true,
    hideOnClick: false,
  });
</script>

<button
  id="location-privacy-tooltip"
  aria-haspopup="true"
  aria-label="Location Privacy"
>
  <CircleHelp aria-hidden="true" width={24} height={24} />
</button>

<span id="location-placeholder" {...Astro.props}>Fetching user location...</span
>

<div id="privacy-notice" class="hidden" aria-hidden="true">
  <span class="mb-3 block text-base font-bold">Privacy Notice</span>

  <p class="text-pretty text-sm font-medium">
    The displayed location is an approximation of the most recent visitor's
    geographical area, derived from their IP address.
  </p>
  <br />
  <p class="text-pretty text-sm font-medium">
    I store this data temporarily for display purposes only and do not
    permanently store, share, or use it for any other purposes.
  </p>
</div>

<style is:global>
  .tippy-box[data-theme~="location"] .tippy-content {
    padding: 1rem;
  }
</style>
